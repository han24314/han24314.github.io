<!DOCTYPE html>


<html lang="en">
  

    <head>
      <meta charset="utf-8" />
        
      <meta
        name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1"
      />
      <title>Solr手册-第八章 Solr分面查询 |  J`Han&#39;s Blog</title>
  <meta name="generator" content="hexo-theme-ayer">
      
      <link rel="shortcut icon" href="/favicon.ico" />
       
<link rel="stylesheet" href="/dist/main.css">

      <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/gh/Shen-Yu/cdn/css/remixicon.min.css"
      />
      
<link rel="stylesheet" href="/css/custom.css">
 
      <script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script>
       
 

      <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-bulma@5.0.1/bulma.min.css"
      />
      <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.19/dist/sweetalert2.min.js"></script>

      <!-- mermaid -->
      
      <style>
        .swal2-styled.swal2-confirm {
          font-size: 1.6rem;
        }
      </style>
    </head>
  </html>
</html>


<body>
  <div id="app">
    
      
    <main class="content on">
      <section class="outer">
  <article
  id="post-Solr手册-第八章-Solr分面查询"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h1 class="article-title sea-center" style="border-left:0" itemprop="name">
  Solr手册-第八章 Solr分面查询
</h1>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2021/10/31/Solr%E6%89%8B%E5%86%8C-%E7%AC%AC%E5%85%AB%E7%AB%A0-Solr%E5%88%86%E9%9D%A2%E6%9F%A5%E8%AF%A2/" class="article-date">
  <time datetime="2021-10-31T02:17:49.000Z" itemprop="datePublished">2021-10-31</time>
</a>   
<div class="word_count">
    <span class="post-time">
        <span class="post-meta-item-icon">
            <i class="ri-quill-pen-line"></i>
            <span class="post-meta-item-text"> Word count:</span>
            <span class="post-count">10.8k</span>
        </span>
    </span>

    <span class="post-time">
        &nbsp; | &nbsp;
        <span class="post-meta-item-icon">
            <i class="ri-book-open-line"></i>
            <span class="post-meta-item-text"> Reading time≈</span>
            <span class="post-count">39 min</span>
        </span>
    </span>
</div>
 
    </div>
      
    <div class="tocbot"></div>




  
    <div class="article-entry" itemprop="articleBody">
       
  <p><a name="z7b4D"></a></p>
<h1 id="序言"><a href="#序言" class="headerlink" title="序言"></a>序言</h1><p>本手册源自《Solr in action》，并修正了部分翻译和说辞，并引入了部分自身的理解，即基于原书进行了二次整理翻译，并不持有任何版权。<br /><a target="_blank" rel="noopener" href="https://livebook.manning.com/book/solr-in-action/about-this-book/">《Solr in action》英文书籍链接(Original Book Link)</a><br /><a target="_blank" rel="noopener" href="https://www.manning.com/">《Solr in action》英文书籍版权归Manning出版社</a><br /><a target="_blank" rel="noopener" href="https://www.phei.com.cn/">《Solr in action》中文译版版权归电子工业出版社</a><br><a name="EYV54"></a></p>
<h1 id="修整说明"><a href="#修整说明" class="headerlink" title="修整说明"></a>修整说明</h1><p>本篇文章于2021/10/31日上传GitHub，如遇版权问题请邮件<code>privatejhan@gmail.com</code>。<span id="more"></span><br><a name="N3pon"></a></p>
<h1 id="本章要点"><a href="#本章要点" class="headerlink" title="本章要点"></a>本章要点</h1><ul>
<li>将分面用于搜索结果的发现、分析与过滤</li>
<li>根据字段分面匹配相关文档，显示每个字段中排名最靠前的值</li>
<li>使用区间分面获得数值与时段的统计数</li>
<li>使用查询分面获得任意复杂查询的文档数</li>
<li>对搜索结果意外的值进行分面操作</li>
</ul>
<p>相较于传统数据库及其他NoSQL数据库相比，分面是Solr最强大的功能之一。分面搜索也称分面导航或分面浏览，它允许用户在执行搜索时，根据文档的一个或多个方面（即分面）对搜索结果进行戏份。用户通过选择不同过滤器来探索搜索结果。<br />比如，搜索新闻网站时，我们希望对搜索结果按照时间选项（前一小时、过去二十四小时、上一周）或类别选项（政治、技术、本地、商业）进行过滤。搜索求职网站时，我们希望对搜索结果按照城市、工作类别、行业甚至公司名称等选项进行筛选。一般来说，这些过滤选项不仅显示了每个分面的可用值，而且统计了每个分面值匹配到搜索结果数。由于屏幕智能为每个分面显示有限数量的值，搜索引擎通常会根据热门程度（文档匹配最多的）对分面值进行排序。这让用户无须查看每个搜索结果，就可以快速了解搜索结果的整体情况。<br />Solr的分面功能将动态元素随搜索结果集一起返回。分面最基本的形式是展示字段中的每个唯一值，这个字段来自于许多文档共享的属性，例如，类目列表。Solr提供了许多高级分面功能，包括基于函数、值区间以及任意查询的搜索结果分面。Solr还支持层级分面、多维分面与多选分面，其中多选分面可以对那些已经从搜索结果中过滤掉的文档进行分面计数。本章会介绍每一种分面用法，这些知识可以帮助你实现分面搜索体验。<br />为了充分理解本章内容，你应该熟悉如何执行查询和查询解析器的工作原理（参见第七章），还需要知道在Solr的schema.xml文件中，如何定义字段的文本分析方法（参见第五章和第六章）。了解Lucene索引如何存储词项对本章学习会有帮助，但这方面的知识不是必须的。<br><a name="Xps1v"></a></p>
<h2 id="8-1-搜索结果预览"><a href="#8-1-搜索结果预览" class="headerlink" title="8.1 搜索结果预览"></a>8.1 搜索结果预览</h2><p>本节概述分面方法，通过举例展示分面可视化的强大用途，以实现最大程度的可用性。分面搜索一般由两个步骤组成：分面的计算与现实，即“分面返回”，有时也简化为“分面”。用户选择一个或多个分面值，对搜索结果进行过滤，即“分面选择”或“分面过滤”。<br />基于这一点，你可能会想知道，搜索引擎返回的分面到底是什么？假设对一组餐馆文档进行搜索，你可能希望在用户界面放置一些分面来作为导航元素，如图8.1所示，查询<code>hamburger</code>返回的分面。<br /><img src="https://cdn.nlark.com/yuque/0/2021/png/2668706/1634398130822-5285076a-6fae-483b-88a4-c9cea18bd098.png#clientId=uc3b1255e-8e84-4&from=paste&id=uc6b949c2&margin=%5Bobject%20Object%5D&name=image.png&originHeight=276&originWidth=986&originalType=binary&ratio=1&size=348754&status=done&style=none&taskId=u68773ab8-00bd-4448-97c6-dc873fcf8b4" alt="image.png"><br />导航元素对于分面是什么提供了清晰的视觉指示，揭开了分面强大功能的冰山一角。每个类别（餐厅类型、州、价格区间及城市）都被视为了一个分面。分面可以看成是描述搜索结果的一个信息切片。在这个示例中，查询<code>hamburger</code>至少匹配到14000个搜索结果，不过你能很容易地发现其中大多数是快餐店，多数餐馆位于大城市，而且多数餐馆的汉堡价格在5美元到10美元区间。<br />图8.1中提供的信息以及很有用了，但还有其他更好的分面可视化方法。显示所有提到的分面值会导致每个分面只能显示少数几个值。图8.2是州分面的另一种展示方式。<br /><img src="https://cdn.nlark.com/yuque/0/2021/png/2668706/1634433864329-0f2b999b-4cfa-4e74-bf93-8955945fee3d.png#clientId=uc3b1255e-8e84-4&from=paste&id=ue5bb6a1e&margin=%5Bobject%20Object%5D&name=image.png&originHeight=452&originWidth=1176&originalType=binary&ratio=1&size=441344&status=done&style=none&taskId=ub79a2e4f-f3ad-424b-aa6e-c076d356b5a" alt="image.png"><br />正如你所见，使用分面可视化来表示那些与用户搜索结果相关的重要元数据，这种方式可以增强搜索体验。图8.3是适合餐馆类型分面的一种可视化呈现。<br /><img src="https://cdn.nlark.com/yuque/0/2021/png/2668706/1634433936286-9345a002-a784-431c-b05a-0939e709901a.png#clientId=uc3b1255e-8e84-4&from=paste&id=ud5331405&margin=%5Bobject%20Object%5D&name=image.png&originHeight=564&originWidth=640&originalType=binary&ratio=1&size=384264&status=done&style=none&taskId=ua9d86a9a-2223-44e7-b092-813da1132ff" alt="image.png"><br />地图和饼图可用于展示离散值，连续值（如数字和日期）一般用线图展示，如图8.4所示。<br />区间分面的线图非常有趣，这种可视化以不间断的序列方式绘制任意的值区间：数字、日期时间、价格、距离以及Solr内部的函数计算值。本章不是专门介绍数据可视化，这里就点到为止。不过，需要引出一个重要观点：分面提供了难以置信的强大功能，对用户搜索提供实时分析，有助于显著提升用户搜索体验。<br /><img src="https://cdn.nlark.com/yuque/0/2021/png/2668706/1634434345375-bcf79aac-0bf4-44f4-8686-9cb8c5176f72.png#clientId=uc3b1255e-8e84-4&from=paste&id=u139b3923&margin=%5Bobject%20Object%5D&name=image.png&originHeight=544&originWidth=852&originalType=binary&ratio=1&size=453757&status=done&style=none&taskId=uca8255e7-ac94-42dd-a2ad-fdccdd2ce50" alt="image.png"><br />在深入了解Solr的分面实现机制之前，还需注意一点，分面会对每个搜索结果集（或从重复搜索的缓存中取回的结果）进行实时计算。每个分面返回一个分面值列表（例如，餐馆类型分面的快餐厅、西餐连锁、本地餐馆、高档餐厅），同时统计出每个分面值包含的文档数。由于一个分面值可能在同一个文档中出现多次，所以统计数值不是该分面值在所有文档中出现的次数，而是匹配到的文档数。事实上，所有分面值是根据搜索结果集进行计算的。这意味着，每当有新的搜索结果，每个分面返回的值与计算都不同。用户执行搜索，查看搜索结果中返回的分面，通过感兴趣的分面值对搜索结果进行过滤，从而执行另一个搜索。<br />在图8.1中。如果用户点击州分面的<code>California</code>值会发生什么？搜索应用根据对该值的过滤，会执行另一个搜索吗？图8.5显示了第二次搜索后的分面值。<br /><img src="https://cdn.nlark.com/yuque/0/2021/png/2668706/1634434682558-14f6ecee-2931-492d-b0e7-25f96e57bb47.png#clientId=uc3b1255e-8e84-4&from=paste&id=udb65e5da&margin=%5Bobject%20Object%5D&name=image.png&originHeight=316&originWidth=1162&originalType=binary&ratio=1&size=416176&status=done&style=none&taskId=u105f6014-970f-4d94-8f11-2e767ca680b" alt="image.png"><br />图8.5只在单一值<code>California</code>上进行了过滤，还可以根据需要在任何给定搜索上使用过个过滤器，每个分面会根据使用的过滤器进行计算。细看第一个搜索<code>全国范围</code>的价格区间分面，与第二个搜索<code>California</code>的结果比较一下，你会发现加州餐馆与每个其他地方餐馆的价格差异，如图8.6所示。<br /><img src="https://cdn.nlark.com/yuque/0/2021/png/2668706/1634434811470-367b42f8-bf73-4c9a-a1b6-106c034556de.png#clientId=uc3b1255e-8e84-4&from=paste&id=u34b01d5b&margin=%5Bobject%20Object%5D&name=image.png&originHeight=544&originWidth=1166&originalType=binary&ratio=1&size=732715&status=done&style=none&taskId=uce811ff1-037f-4a67-a973-5f3bc2dbaa3" alt="image.png"><br />8.5小结会介绍如何在分面值上使用这些过滤器。这里强调一个重要观点：分面为用户在查看特定查询的结果时提供了丰富的洞察力，用户能够很容易地评价搜索质量，再选择他们感兴趣的方面深入下去。<br><a name="k4JkR"></a></p>
<h2 id="8-2-建立测试数据"><a href="#8-2-建立测试数据" class="headerlink" title="8.2 建立测试数据"></a>8.2 建立测试数据</h2><p>在深入了解分面机制之前，我们需要在Solr中加载一些示例数据，以便本章后续内容的示例讲解。示例数据是8.1小节餐馆示例文档中的子集。本节创建并加载餐馆文档，供本章后续内容介绍中使用分面功能。向Solr提交这些示例文档，首先需要将代码清单8.1中定义的字段添加到Solr的<code>schema.xml</code>文件（参见第五章）。<br /><img src="https://cdn.nlark.com/yuque/0/2021/png/2668706/1634435034536-4fa52385-3410-44c2-b124-4c3827b94f63.png#clientId=uc3b1255e-8e84-4&from=paste&id=u7395b24e&margin=%5Bobject%20Object%5D&name=image.png&originHeight=568&originWidth=1142&originalType=binary&ratio=1&size=742826&status=done&style=none&taskId=u313f17cd-3ab3-48f3-9d33-785cdcb4398" alt="image.png"><br /><img src="https://cdn.nlark.com/yuque/0/2021/png/2668706/1634435050977-415941ee-b7c3-4687-b8db-f3ae2cd04379.png#clientId=uc3b1255e-8e84-4&from=paste&id=uc2c99fe2&margin=%5Bobject%20Object%5D&name=image.png&originHeight=106&originWidth=1060&originalType=binary&ratio=1&size=57991&status=done&style=none&taskId=ud0a440d8-6983-4ab0-9934-6092728c80b" alt="image.png"><br />该<code>schema</code>定义了打算进行分面的每个字段。每个字段被定义为既是索引字段也是存储字段，但存储仅用于演示目的。分面仅使用字段的索引值，如果不需要以其他方式检索它们的话，就可以将文档标记为索引而不存储。代码清单8.2是即将进行分面的每个文档。<br /><img src="https://cdn.nlark.com/yuque/0/2021/png/2668706/1634435180192-53663523-f398-445c-8a2c-22d688a9be0e.png#clientId=uc3b1255e-8e84-4&from=paste&id=ubb21d39a&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1330&originWidth=1176&originalType=binary&ratio=1&size=1358861&status=done&style=none&taskId=ubf60dbed-69a7-42a2-bc3e-559eed5cc34" alt="image.png"><br /><img src="https://cdn.nlark.com/yuque/0/2021/png/2668706/1634435211836-3cb7c186-efd4-4c32-9887-1799713762b9.png#clientId=uc3b1255e-8e84-4&from=paste&id=ucf1a24fe&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1640&originWidth=1092&originalType=binary&ratio=1&size=1416196&status=done&style=none&taskId=ub89e04f6-dd09-4ae7-8be8-9a14a71be1e" alt="image.png"><br />代码清单8.1的示例<code>schema.xml</code>和代码清单8.2的示例文档<code>restaurants.json</code>文件可以从本书官方网站下载。下载源代码并解压缩到一个文件夹，书中使用<code>$SOLR_IN_ACTION</code>替代具体路径。执行以下命令来配置餐馆文档的<code>schema</code>（代码清单8.1）并启动Solr：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd $SOLR_INSTALL/example/</span><br><span class="line">cp -r $SOLR_IN_ACTION/example-docs/ch8/cores/restaurants/solr/restaurants/</span><br><span class="line">java -jar start.jar</span><br></pre></td></tr></table></figure>
<pre><code>Solr成功运行之后，使用以下命令向Solr提交代码清单8.2的文档：
</code></pre>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd $SOLR_IN_ACTION/example-docs/</span><br><span class="line">java -Durl=http://localhost:8983/solr/restaurants/update</span><br><span class="line">-Dtype=application/json</span><br><span class="line">-jat post.jar ch8/documents/restaurants.json</span><br></pre></td></tr></table></figure>
<pre><code>命令的最后一行使用Solr内置的 `post.jar`工具，从文本文件中索引了餐馆数据。这里指定的是JSON格式，而不是默认的XML格式。如果一切顺利，你应该会看到类似如下的输出：&lt;br /&gt;![image.png](https://cdn.nlark.com/yuque/0/2021/png/2668706/1634435630067-bd0821c7-e205-435f-be38-e67337f92002.png#clientId=uc3b1255e-8e84-4&amp;from=paste&amp;id=uf240b233&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=274&amp;originWidth=952&amp;originalType=binary&amp;ratio=1&amp;size=234254&amp;status=done&amp;style=none&amp;taskId=ua54afe39-199d-4af7-b35a-45c192bf5b1)&lt;br /&gt;为餐馆文档成功建立索引后，Solr的标准搜索处理器就可以发挥作用了。使用`http://localhost:8983/solr/restaurants/select?q=*:*`来确认Solr中索引的这些文档，以及来自代码清单8.2的所有字段。
</code></pre>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">更改Solr响应格式</span><br><span class="line">	请注意，本章以及后续章节中大多数文档和Solr的响应格式都采用JSON格式，而不是默认的XML格式。因为JSON是一种易读的、更紧凑的格式，适合演示用途。将wt=json参数添加到Solr请求中，可将响应格式从XML更改到JSON格式。如果没有在solrconfig.xml中将默认响应格式从XML修改为JSON，那么本章中Solr的所有请求都需要添加wt=json参数，以便用同一种格式返回结果。</span><br><span class="line">  本章中所有的Solr响应格式都经过缩进处理。在Solr的URL中添加indent=on参数来实现缩进。一般不推荐在生产环境中对响应格式进行缩进。虽然这样做是可以的，但会增加不必要的需要另外处理的空格。但是缩进会让Solr的相应更加可读，所以本章的所有例子都使用缩进排版。</span><br><span class="line">  为避免重复说明，本章假设对所有查询都设置&amp;wt=json&amp;indent=on作为默认参数（具体做法参见第四章）。</span><br></pre></td></tr></table></figure>
<pre><code>Solr给出的相应包含20个示例餐馆文档，每个文档包含7个已定义的字段，示例餐馆数据集如下所示：&lt;br /&gt;![image.png](https://cdn.nlark.com/yuque/0/2021/png/2668706/1634438694785-0a724d76-b7c3-4833-8864-ed4e99f11132.png#clientId=uc3b1255e-8e84-4&amp;from=paste&amp;id=u4392f914&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=594&amp;originWidth=696&amp;originalType=binary&amp;ratio=1&amp;size=263563&amp;status=done&amp;style=none&amp;taskId=u7eba59f3-b816-43f4-994e-2d4f5a17eba)&lt;br /&gt;现在20个实例文档可以被搜索了，接下来执行分面搜索。我们从分面的最常见形式开始，即基于字段内的每个唯一值进行分面。
</code></pre>
<p><a name="nxJxx"></a></p>
<h2 id="8-3-字段分面"><a href="#8-3-字段分面" class="headerlink" title="8.3 字段分面"></a>8.3 字段分面</h2><p>字段分面是最常见的分面形式。执行搜索时，根据查询请求返回特定字段中找到的唯一值以及找到的文档数。8.1节以可视化方式展示了餐馆例子用到的几个字段：餐馆类型<code>type</code>分面、州<code>state</code>分面与城市<code>city</code>分面。本节会介绍如何构建一个Solr查询来请求字段分面，如何调整分面参数来改变分面值的计算方式与返回方式。<br />处于本章其余内容的演示需要，在8.2节中索引过的文档上进行分面。让我们来执行第一个分面：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:8983/solr/restaurants/select?q=*:*&amp;row=0</span><br><span class="line">&amp;facet=true&amp;facet.field=name</span><br></pre></td></tr></table></figure>
<pre><code>查询结果详见代码清单8.3.&lt;br /&gt;![image.png](https://cdn.nlark.com/yuque/0/2021/png/2668706/1634478202397-0a2787f2-eae6-45e4-8e21-babca5c660e7.png#clientId=uc3b1255e-8e84-4&amp;from=paste&amp;id=u4eb1c864&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=688&amp;originWidth=1146&amp;originalType=binary&amp;ratio=1&amp;size=283935&amp;status=done&amp;style=none&amp;taskId=u3b8f202d-f948-4ee3-bcda-0ace7aab185)&lt;br /&gt;这个例子展示了Solr分面的基础形式`单值字段分面`。在这种分面中，每个唯一值都会被检视，并返回每个值对应的文档数。由于每个文档只需要一个值，因此值的统计总数等于文档总数，这里的值是餐馆名称。&lt;br /&gt;然而，并不是Solr的所有字段都包含单一值。标签`tags`字段就是多值字段的一个例子。如果对标签字段进行分面会怎样？详见代码清单8.4.&lt;br /&gt;![image.png](https://cdn.nlark.com/yuque/0/2021/png/2668706/1634478359295-7a097bac-0ad6-4d2b-9c1d-c82c35f8870f.png#clientId=uc3b1255e-8e84-4&amp;from=paste&amp;id=ue0afc85d&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=408&amp;originWidth=1152&amp;originalType=binary&amp;ratio=1&amp;size=372255&amp;status=done&amp;style=none&amp;taskId=ue8f44812-18f7-43a4-8b8a-a8853a33640)&lt;br /&gt;![image.png](https://cdn.nlark.com/yuque/0/2021/png/2668706/1634478380627-c5ff5d14-434a-45b4-b52c-02192094002f.png#clientId=uc3b1255e-8e84-4&amp;from=paste&amp;id=u6bae09c6&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=418&amp;originWidth=1158&amp;originalType=binary&amp;ratio=1&amp;size=235125&amp;status=done&amp;style=none&amp;taskId=uf240886f-e9bd-481c-9217-62ae59ba6f6)&lt;br /&gt;有趣的是，`breakfast`与`coffe`是整个餐馆文档语料库中最流行的两个标签。这是因为星巴克和麦当劳这两家都被打上了这两个标签。如果搜索`breakfas`或`coffe`，Solr返回的结果与事实是吻合的。&lt;br /&gt;还需注意一点，标签分面值的总和远大于20，这个数字是搜索引擎中的文档总数。之所以出现这种情况是因为，文档包含多个标签，也就是说，多个标签可以对应到同一个文档，因此大多数文档被不止一个分面值记过数。&lt;br /&gt;![image.png](https://cdn.nlark.com/yuque/0/2021/png/2668706/1634478590144-372fddba-0b8d-4074-80d5-0958a61792f5.png#clientId=uc3b1255e-8e84-4&amp;from=paste&amp;id=u015137c4&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=348&amp;originWidth=1134&amp;originalType=binary&amp;ratio=1&amp;size=425147&amp;status=done&amp;style=none&amp;taskId=u8d9721ab-0eaa-4c83-a9b6-b68fe9853db)&lt;br /&gt;标签云是用户从分类角度概览搜索结果的一种常见方式。除了在这个例子中使用标签，分面也常用语包含日常用语的原生内容字段（如餐馆描述全文），已帮助用户快速了解内容字段的含义。对原生内容字段使用分面的问题是，日常用语包含无意义词汇（例如`and`、`of`、`like`这类词），这样会产生很多噪声。在对文档的描述上，原生内容字段就不如打标签那么可靠有效了。&lt;br /&gt;另外还需注意，进行分面时，字段分面的返回值是基于该字段的索引值。这意味着，如果传入词项`San Francisco, CA`，该字段会被作为文本字段进行分词，以空格和逗号分隔，并且文本会进行小写转换。然后，在Solr索引中，该字段的值会变为`ca`、`francisco`和`san`。因此，除非要对每个词项单独进行分面统计和小写转换，否则在`schema.xml`中创建字段定义时就要考虑字段的分面问题。一种标准做法是，Solr开发者创建了一个单独的字段，在该字段中放入特定内容的副本，该字段仅用于分面目的，这样原始文本就能够以可分娩的形式保留。&lt;br /&gt;读到此处，你应该熟悉了分面的基本知识，也知道了如何在单值字段和多值字段上进行分面。至此，本章只介绍了返回一个分面的默认设置。处理20个文档对分面来说很容易，如果在Solr的分面请求中需要返回数以千计或百万数量级的唯一词项，那又会怎样？所幸，Solr拥有许多分面选项，允许对每个查询返回的分面进行微调。表8.1是字段分面的参数一览表。&lt;br /&gt;![image.png](https://cdn.nlark.com/yuque/0/2021/png/2668706/1634479021983-31c4c6c2-2fff-4706-9b99-955a42849858.png#clientId=uc3b1255e-8e84-4&amp;from=paste&amp;id=u7800f572&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=1106&amp;originWidth=1174&amp;originalType=binary&amp;ratio=1&amp;size=1377114&amp;status=done&amp;style=none&amp;taskId=u02cc2dba-df37-4a3a-9271-5ef26b788a1)&lt;br /&gt;![image.png](https://cdn.nlark.com/yuque/0/2021/png/2668706/1634479038688-ed681211-5ec7-4e61-a643-4ccb4e006b3f.png#clientId=uc3b1255e-8e84-4&amp;from=paste&amp;id=u39d12cb3&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=332&amp;originWidth=1148&amp;originalType=binary&amp;ratio=1&amp;size=419886&amp;status=done&amp;style=none&amp;taskId=ua7e0eaf6-47a8-416f-abca-ef88852c37a)&lt;br /&gt;表8.1需要注意一点，通过制定多个`facet.field`参数可以实现多个分面的请求。此外，表中列出的一些分面参数应用在字段级别上，使用以下语法进行指定：
</code></pre>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">f.&lt;fieldName&gt;.&lt;FacetParameter&gt;=&lt;value&gt;</span><br></pre></td></tr></table></figure>
<pre><code>如果要对美国所有50个州（按字母顺序排序）进行分面，每个州至少有一个餐馆，而且要显示餐馆名（及时餐馆名与查询并不匹配）以及匹配到的前5个标签，让我们执行代码清单8.5的查询。&lt;br /&gt;![image.png](https://cdn.nlark.com/yuque/0/2021/png/2668706/1634479278758-d8d66c40-02c0-4166-a06a-ea9e504063be.png#clientId=uc3b1255e-8e84-4&amp;from=paste&amp;id=u8e1f85ff&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=874&amp;originWidth=1144&amp;originalType=binary&amp;ratio=1&amp;size=720248&amp;status=done&amp;style=none&amp;taskId=uce3de70d-e033-4189-94b8-3788a3b2bd1)&lt;br /&gt;![image.png](https://cdn.nlark.com/yuque/0/2021/png/2668706/1634479304101-49a611ff-1b5a-43bf-8784-c85140c64ec7.png#clientId=uc3b1255e-8e84-4&amp;from=paste&amp;id=ue7ead02a&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=298&amp;originWidth=1146&amp;originalType=binary&amp;ratio=1&amp;size=175180&amp;status=done&amp;style=none&amp;taskId=ue5ed1292-6381-45ef-b540-c0d28ed913a)&lt;br /&gt;正如你所见，代码清单8.5在多个字段上设置了分面选项，自定义了搜索结果返回的具体内容。虽然该查询需要设置许多参数，但分面选项带来的灵活性，值得去做一些额外操作。&lt;br /&gt;至此，你已经学会了如何在Solr请求返回字段分面，在已索引的字段上查看与每个唯一值匹配的文档数。字段分面功能以及很强大了，但还有更灵活的分面选项可供选用。接下来介绍查询分面，对无论多么复杂的查询都能返回分面计数。
</code></pre>
<p><a name="b7oWm"></a></p>
<h2 id="8-4-查询分面"><a href="#8-4-查询分面" class="headerlink" title="8.4 查询分面"></a>8.4 查询分面</h2><p>之前小节讨论过，对任意索引字段使用分面返回最靠前的值，这种做法很好。在任意子查询上使用这种做法也很有用，这样就可以知道未来的搜索可能匹配出多少结果，并基于该数字提供相应的分析。Solr通过查询分面实现这个功能。<br />展示查询分面功能的最好方式是举例说明。参见8.2节的餐馆搜索数据集，假设我们要查询价格区间在5美元到25美元的餐馆，而且想要了解美国东海岸、西海岸和中部地区的餐馆分布情况。通过3个不同的查询就可以达到查询目的，详见代码清单8.6.<br /><img src="https://cdn.nlark.com/yuque/0/2021/png/2668706/1634524572081-f41b8fb9-c5e0-445c-802a-15f7d702ce59.png#clientId=u61f0efd5-6ca8-4&from=paste&id=uacf0fc08&margin=%5Bobject%20Object%5D&name=image.png&originHeight=248&originWidth=1112&originalType=binary&ratio=1&size=279074&status=done&style=none&taskId=u11ae7abe-2689-4657-918b-829ea52d18c" alt="image.png"><br /><img src="https://cdn.nlark.com/yuque/0/2021/png/2668706/1634524607348-23654bf4-0a40-4500-af90-e11a541fb7a7.png#clientId=u61f0efd5-6ca8-4&from=paste&id=u118e3615&margin=%5Bobject%20Object%5D&name=image.png&originHeight=352&originWidth=1106&originalType=binary&ratio=1&size=257811&status=done&style=none&taskId=u523d5373-1e8c-41b4-96d9-817a3ad444b" alt="image.png"><br />上面的示例告诉我们，Solr子查询对搜索结果计数是最简单粗暴的方法，分面运行每个子查询就可以确定搜索结果总数。在本例的小数据集上，虽然这种方式没有操作不便之处，但这样做完全没有必要。代码清单8.7演示了如何使用查询分面轻松地将多个子查询组合起来。<br /><img src="https://cdn.nlark.com/yuque/0/2021/png/2668706/1634656538204-f38fd9b0-3287-4dc1-8e86-b438f20619e0.png#clientId=u61f0efd5-6ca8-4&from=paste&id=u1dfc7348&margin=%5Bobject%20Object%5D&name=image.png&originHeight=566&originWidth=1104&originalType=binary&ratio=1&size=524285&status=done&style=none&taskId=uf05b1ff8-6f70-4e3a-b2db-7e9f6d94586" alt="image.png"><br />正如你所见，多个子查询通过查询分面可以组合成一个Solr请求。之前的例子是针对特定数据集的，因为查询的是所有已知的可能分面值。8.1节其实已经给出了一个查询分面例子<code>基于价格的分面</code>，这里的价格区间并不是均匀间隔的。我们使用测试数据重新创建这个例子，详见代码清单8.8。<br /><img src="https://cdn.nlark.com/yuque/0/2021/png/2668706/1634656680410-5ef5b1d9-5214-4040-9aa2-c94aaa7d15f6.png#clientId=u61f0efd5-6ca8-4&from=paste&id=u46d3ba58&margin=%5Bobject%20Object%5D&name=image.png&originHeight=612&originWidth=1114&originalType=binary&ratio=1&size=524041&status=done&style=none&taskId=u8380e37a-3710-454c-8403-5c54be1e124" alt="image.png"><br />这个例子演示了查询分面在查询阶段如何针对任意Solr查询有效地创建新的信息区间。实际上，在Solr中可以很容易地创建一个新字段。例如，新建<code>price_range</code>字段存储每一段区间值。这一操作还需要基于新的<code>price_range</code>字段进行字段分面，找出5个区间中各自包含的值。这也要求在Solr索引内容时使用这些区间分段规则。因此，如果区间段发生变化就必要重新索引文档，这个过程并不容易，特别是在Solr中累计了大量内容之后尤其不易。查询分面提供了一种很好的替代方法，在查询时可完全自由地指定或重新定义哪些分面值需要计算和返回。<br />本节的例子虽然都很简单，但它们足以说明，基于任意查询的分面具有非常大的灵活性。Solr提供了许多强大的查询功能，包括嵌套查询（参见第七章）和函数查询（参见第十五章），基于分面的高级查询能够帮助你做到所能想到的一切。例如，利用Solr的半径查询，可以围绕特定地点创建同心圆（5公里以内、5<del>10公里、10</del>20公里以及20公里以上），形成基于位置举例的分面。另外，将自定义相关度函数作为函数查询，可以基于函数计算值生成查询分面。分面的扩展能力非常强，根据特定搜索需求可以灵活设置分面。<br />虽然查询分面非常灵活，但它们也有可能对Solr请求造成负担。这是因为分面计算的生成所依赖的单一值都必须明确指定。下一节介绍Solr的区间分面功能，它让给予数值和日期的分面变得更加容易实现。<br><a name="NRl1H"></a></p>
<h2 id="8-5-区间分面"><a href="#8-5-区间分面" class="headerlink" title="8.5 区间分面"></a>8.5 区间分面</h2><p>顾名思义，区间分面将数值和日期字段值分成一些区间段，以便于Solr返回各个区间以及它们包含的文档数。创建多个不同的查询分面来表示多个区间值的做法，可以用区间分面很好地替代。<br />上一节根据8.2节示例数据的价格字段创建了一个查询分面。搜索引擎返回的值均匀分布，类似的分面技术通过Solr的区间分面返回，详见代码清单8.9.<br /><img src="https://cdn.nlark.com/yuque/0/2021/png/2668706/1634718293251-c727387a-b6bc-4796-afbc-26677c7a9472.png#clientId=u61f0efd5-6ca8-4&from=paste&id=u1419e37a&margin=%5Bobject%20Object%5D&name=image.png&originHeight=900&originWidth=1110&originalType=binary&ratio=1&size=584806&status=done&style=none&taskId=u964c05b0-d2ff-46e4-b300-db8e4973944" alt="image.png"><br />这个例子的输出与代码清单8.8的结果相似，但有两点不同。首先，区间分面返回了查询落在<code>facet.range.start</code>和<code>facet.range.end</code>两个参数见的每个区间段的统计数，有些不包含文档的区间也被返回了。其次，与代码清单8.7的查询分面不同的是，根据<code>facet.range.gap</code>参数设置，区间分面的区间间隔是相同的。根据应用需求可以调整间隔，以创建更大或更小的区间段。返回所有区间段的做法会节省大量时间，因为不必设置许多<code>facet.query</code>参数就可以实现类似的效果。<br />区间分面还有其他一些参数可供选择，包括<code>facet.range.hardend</code>、<code>facet.range.other</code>和<code>facet.range.include</code>。表8.2列出了区间分面参数及其可用选项。<br /><img src="https://cdn.nlark.com/yuque/0/2021/png/2668706/1634731575763-228c5961-b598-4204-a540-c72a8c2c7b9a.png#clientId=u61f0efd5-6ca8-4&from=paste&id=u11711cdc&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1226&originWidth=1112&originalType=binary&ratio=1&size=1450057&status=done&style=none&taskId=u8256818c-f4a3-4b38-aac5-6b4afbe3d74" alt="image.png"><br />从表8.2可以看出，Solr的区间分面参数提供了丰富的选项。与字段分面一样，区间分面的一些参数使用<code>facet.$&#123;fieldName&#125;.&#123;facetParameter&#125;=$&#123;value&#125;</code>在字段上指定。<br />对数值和日期值进行分面时，相较于查询分面，区间分面提供了更方便和更简洁的查询语法。当区间分面变得过于复杂时，也可以反过来使用查询分面，以利用Solr的强大查询功能，8.4节曾讨论过（更多内容参见第十五章）。以上介绍了三种分面，其中字段分面是使用最广泛和最简单的分面类型。对于每一种分面类型，我们已经了解了如何向Solr请求返回分面值。还有一个问题没有讨论，如果用户选择了一个分面，如如何进行后续的查询限定？这是下一节要讨论的话题。<br><a name="ZmOfL"></a></p>
<h2 id="8-6-基于分面值的过滤"><a href="#8-6-基于分面值的过滤" class="headerlink" title="8.6 基于分面值的过滤"></a>8.6 基于分面值的过滤</h2><p>为了让用户根据分面对搜索结果进行探索，Solr返回分面只是第一步。向用户展示分面值之后，下一步是让用户点击一个或多个分面值，将其作为过滤器使用。本节讨论这些过滤器的最佳使用方法。<br><a name="cHpZJ"></a></p>
<h3 id="8-6-1-在分面上使用过滤器"><a href="#8-6-1-在分面上使用过滤器" class="headerlink" title="8.6.1 在分面上使用过滤器"></a>8.6.1 在分面上使用过滤器</h3><p>在初级水平时，在向查询中添加额外的过滤器<code>fq参数</code>相比，在分面上使用过滤器没那么困难。假设在搜索中返回三个分面，两个字段分面（州字段和城市字段）和一个查询分面（价格字段），初始查询和搜索结果详见代码清单8.10。<br /><img src="https://cdn.nlark.com/yuque/0/2021/png/2668706/1634732834214-fc7faf1b-2fbf-4fbf-b256-17496dc939ba.png#clientId=u61f0efd5-6ca8-4&from=paste&id=uac36f760&margin=%5Bobject%20Object%5D&name=image.png&originHeight=824&originWidth=1118&originalType=binary&ratio=1&size=644089&status=done&style=none&taskId=uc922f89d-7070-4e1f-bd07-f525ad92668" alt="image.png"><br /><img src="https://cdn.nlark.com/yuque/0/2021/png/2668706/1634732862189-e35ee11b-79f6-42e8-b276-ce747418196c.png#clientId=u61f0efd5-6ca8-4&from=paste&id=u3c1ee0f7&margin=%5Bobject%20Object%5D&name=image.png&originHeight=328&originWidth=1090&originalType=binary&ratio=1&size=104897&status=done&style=none&taskId=uf1226290-0066-42df-8d05-aa97a97b836" alt="image.png"><br />搜索结果也会返回，但没有显示在代码清单8.10中。搜索界面可能会向用户显示这个全面查询的可用分面值。在这里例子中，如何根据一个分面值进行过滤呢？其实你已经知道该怎么做了，在查询中为每个选中的分面值添加一个过滤器。代码清单8.11展示了第二轮搜索，用户点击了<code>California</code>。<br /><img src="https://cdn.nlark.com/yuque/0/2021/png/2668706/1634737104177-959c6d7b-72d8-42c6-a356-6d37dc72cc0d.png#clientId=u61f0efd5-6ca8-4&from=paste&id=u992be72b&margin=%5Bobject%20Object%5D&name=image.png&originHeight=868&originWidth=1108&originalType=binary&ratio=1&size=706445&status=done&style=none&taskId=u90950c52-0d1d-4aff-9a8f-313f69028a2" alt="image.png"><br />代码清单8.11与代码清单8.10的不同之处在于，用户连续使用了分面。用户执行初始搜索得到一组分面，然后选择一个分面继续搜索，通过过滤器缩小搜索结果范围。接着还可以继续执行第三轮搜索，详见代码清单8.12.<br /><img src="https://cdn.nlark.com/yuque/0/2021/png/2668706/1634737254559-7b4ee8c7-cd72-446f-9665-54ce43e0cf38.png#clientId=u61f0efd5-6ca8-4&from=paste&id=uc55a4d9b&margin=%5Bobject%20Object%5D&name=image.png&originHeight=846&originWidth=1096&originalType=binary&ratio=1&size=711091&status=done&style=none&taskId=ua6bdefb5-24ef-46e6-8a6c-009ae10ee59" alt="image.png"><br />这里使用了<code>state:California</code>和<code>price:[* TO 10]</code>两个过滤器，搜索结果得到了进一步细化。与查询限定相匹配的搜索结果只有两家加州餐馆，而且两家餐馆都位于加州的旧金山市。<br />值得注意的是，这里每个例子处理的都是单一值字段的分面。因此，在该分面值上进行过滤，就不会返回与其他分面值匹配的文档。这对单值字段来说是有意义的。如果一个文档只能拥有一个价格或只能出现在一个州，那么它就不会出现在现在选择了其他价格分面和州分面的情况中。然而，并不是所有的字段都只包含单一值。在Solr的<code>schema.xml</code>文件中，字段被标记为多值或要被分词，这两种情况都会对分面产生多个词项。以餐馆索引的多值标签字段为例，我们来看看如何实现多值字段的分面。代码清单8.13对标签字段连续使用过滤器进行的多次搜索。<br /><img src="https://cdn.nlark.com/yuque/0/2021/png/2668706/1634821254012-832d3604-17a9-4398-bc55-c82a5c0e0d1d.png#clientId=u61f0efd5-6ca8-4&from=paste&id=ud473e516&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1484&originWidth=1218&originalType=binary&ratio=1&size=1132024&status=done&style=none&taskId=u444da5e9-5ac9-4605-8d8b-474c8827fc3" alt="image.png"><br /><img src="https://cdn.nlark.com/yuque/0/2021/png/2668706/1634821366772-e0eed9e1-5e7d-4288-8d95-9e82f5f62a9f.png#clientId=u61f0efd5-6ca8-4&from=paste&id=uf3d413bb&margin=%5Bobject%20Object%5D&name=image.png&originHeight=640&originWidth=1090&originalType=binary&ratio=1&size=485939&status=done&style=none&taskId=u07a75d32-a10b-4617-94c9-0c8a181820f" alt="image.png"><br />从代码清单8.13可以看出，多值字段可以继续返回其他值，只要包含这些值的文档仍然能匹配所有在用的过滤器即可。值的注意的是，这些例子对每个选定的过滤器值在Solr的URL中指定了各自的<code>fq</code>参数，但其实没必要这样做。事实上，代码清单8.13中最后一个搜索的过滤器<code>fq=tags:coffee&amp;fq=tags:hambuigers</code>可以轻松地转换为<code>fq=tags:(coffee AND humburgers)</code>，或者其他等价的布尔逻辑表达式。这种转换需要在Solr的过滤器缓存中少数几次查找（参见第四章），而且还提供了与过滤器质交互的更多控制。<br />不要使用<code>AND</code>逻辑来链接每个分面过滤器，使用<code>OR</code>逻辑来链接分面过滤器才是正确有效的使用方法。例如，当用户选择多个城市时，过滤出选中的那些城市。8.7节会讨论多选分面，教你如何在分面中一次选中多个过滤器，这种方法对单值字段也适用。<br><a name="Yzzz1"></a></p>
<h3 id="8-6-2-基于分面值的安全过滤方法"><a href="#8-6-2-基于分面值的安全过滤方法" class="headerlink" title="8.6.2 基于分面值的安全过滤方法"></a>8.6.2 基于分面值的安全过滤方法</h3><p>以上的分面过滤器示例都是基于单值词项的，例如，<code>coffee</code>或<code>hamburgers</code>。事实上，分面返回的词项在处理上更有难度，例如，短语型词项的处理。举例来说，如何对短语型词项<code>Los Angeles</code>进行分面？你可能已经知道，过滤器<code>fq=city:Los Angeles</code>是无效的。因为从语法上看，这个过滤器需要在默认的待查字段中找寻包含<code>Los</code>城市和<code>Angeles</code>词项的文档。为了处理以空格分隔的短语，大多数Solr开发者会使用引号把分面的所有词项括起来。因此，查询语法应该是这样的<code>fq=city:&quot;Los Angeles&quot;</code>。<br />不过，盲目地使用引号把要过滤的词项括起来可能也会遇到问题。如果词项本身包含引号，那么不做转义处理的话，语法就会出错。因此，如果搜索歌曲集索引，对<code>the &quot;in&quot; crowd</code>这首歌进行分面，就需要使用转义符才能将词项更安全地传递给Solr，正确的过滤器语法为<code>fq=name:&quot;the \&quot;in\&quot; corwd&quot;</code>。除了注意引号和转义引号之外，还必须留意在分面的字段上进行的所有文本处理操作。正如第六章曾介绍过，基于字段的文本分析在内容索引与查询两个阶段可以分别定义。因此，如果配置存在匹配失误（通常不是好的做法），这可能说明，尝试过滤的值与分面返回的文档不一致。<br />所幸，我们有一个非常简单的解决方法，它能够确保分面返回值与随后的过滤器两个找到准确一致的文档，即使用词项查询解析器<code>TermQParserPluhin</code>，参见第七章。此查询解析器的一个好处在于，绕过了字段上已定义的文本分析链，直接将词项与Solr索引进行匹配。这样做节省了文本处理时间，并且避免了之前讨论过的引号和转义逻辑等问题。词项查询解析器在<code>Los Angeles</code>上使用语法为<code>fq=&#123;!term&#125;Los Angeles</code>，在歌曲<code>the &quot;in&quot; corwd</code>上使用的语法为<code>fq=&#123;!term&#125;the &quot;in&quot; crowd</code>。<br />对所有分面过滤器使用词项查询解析器的做法存在一个缺点，即它不支持布尔语法。因此，如果要在一个过滤器李组合多个分面值，那么需要使用嵌套查询语法（参见第七章）。代码清单8.14演示了这两种做法：一种是分面为每个分面词项使用过滤器；另一种是通过词项查询解析器把这些分面词项组合成为一个过滤器。<br /><img src="https://cdn.nlark.com/yuque/0/2021/png/2668706/1634884126435-a66666f3-1ee1-40c2-9be0-22b862349ce1.png#clientId=u61f0efd5-6ca8-4&from=paste&id=uf2442e9b&margin=%5Bobject%20Object%5D&name=image.png&originHeight=410&originWidth=1116&originalType=binary&ratio=1&size=484671&status=done&style=none&taskId=ue63b842d-a39f-4c79-8caf-18ab61c97fc" alt="image.png"><br />无论使用哪一种方式实现分面过滤器，查询解析过滤器都会让查询速度变得更快一些。如果选择使用第二种方法<code>嵌套查询语法</code>，由于整个嵌套查询包含在引号中，所以需要在词项中添加转义引号。如果在分面过滤器中使用布尔逻辑，那么这种方式可能会造成一些麻烦。<br />本节中我们已经看到，在分面上使用过滤器与过滤器的其他使用没有什么差异。在每个分面上分别使用过滤器或在多个分面上使用一个过滤器，这两种方法都是可以行的。此外，在使用分面过滤器时，通过词项查询解析器绕过文本处理，可以避免难以处理的字符转义问题。至此，我们学会了各种基础类型分面的请求与过滤操作，还有更多内容有待深入学习。下一节介绍分面使用的一些其他方法，比如。处于显示目的的分面重命名，以及对过滤掉的文档进行分面计数等。<br><a name="SRRf9"></a></p>
<h2 id="8-7-多选分面、键与标记"><a href="#8-7-多选分面、键与标记" class="headerlink" title="8.7 多选分面、键与标记"></a>8.7 多选分面、键与标记</h2><p>向Solr请求分面时，显示给用户看的分面名称并不总是那个直观易懂，即使在搜索应用技术系统中处理分面名称也可能存在这样的问题。Solr提供了方便的分面重命名方法，可以在分面返回时对其进行重命名，使之更符合应用场景的理解和使用。Solr还可以对过滤掉的文档进行分面计算，这对多选分面而言非常有用。对搜索结果进行过滤后，仍然可以看到被过滤掉的、在过滤器应用之前与查询匹配的相关文档数。本节介绍键<code>key</code>、标记<code>tag</code>、与排斥<code>exclude</code>局部参数（第七章介绍过局部参数），利用它们来实现分面重命名与分面多选功能。<br><a name="J9rac"></a></p>
<h3 id="8-7-1-键"><a href="#8-7-1-键" class="headerlink" title="8.7.1 键"></a>8.7.1 键</h3><p>所有的分面都有名称，方便开发者进行识别。默认情况下，字段分面与区间分面的分面名称就是字段名，查询分面的分面名称是基于分面值和计算的查询本身。使用键这个局部参数可以方便地对分面进行重命名，详见代码清单8.15所示。<br /><img src="https://cdn.nlark.com/yuque/0/2021/png/2668706/1634886128185-d77fefc7-462d-4917-a95b-969a41ee19c0.png#clientId=u61f0efd5-6ca8-4&from=paste&id=u5687296f&margin=%5Bobject%20Object%5D&name=image.png&originHeight=554&originWidth=1114&originalType=binary&ratio=1&size=550885&status=done&style=none&taskId=u5185ae42-7287-4b53-b7a9-9774b7213af" alt="image.png"><br /><img src="https://cdn.nlark.com/yuque/0/2021/png/2668706/1634886198397-ddfa7c60-ba6a-4484-93d9-e1ce8d97e872.png#clientId=u61f0efd5-6ca8-4&from=paste&id=u64aad5f9&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1186&originWidth=1126&originalType=binary&ratio=1&size=973243&status=done&style=none&taskId=u0ae2b2ca-5e7a-49c6-a5a2-403d7006597" alt="image.png"><br />分面重命名适合于很多应用场景。它允许搜索应用请求查询分面，例如，在后置处理阶段不需要搜索应用对结果集的查询进行解析。它还能为分面赋予用于易于理解的名称，不管分面的底层字段与查询怎么样，让搜索界面上的结果显示更加直观。此外，每个分面字段是唯一的，通过键的指定，在相同字段上可以定义不止一个分面（这对字段分面和区间分面而言是有用的），返回的每个分面都有唯一的名称。这种方法的有点是，根据查询阶段的规则，它可以让多个字段映射成同一个名称。<br />假设，搜索索引有两个字段：<code>SecretInformationOnlyAvailableToSomeUsers</code>和<code>InformationAvailableToAllUsers</code>。根据这样的设置，在查询阶段创建一个分面，指定<code>facet.field=&#123;!key=&quot;Information&quot;&#125;SecretInformationOnlyAvailableToSomeUses</code>或<code>facet.field=&#123;!key=&quot;Information&quot;&#125;InformationToAllUsers</code>。这种间接层在许多应用场景中使用起来非常方便。例如，想在任何时候重新定义分面，让它指向一个不同的字段，使用这种间接层对应用技术体系的改动将会很小。除了分面重命名，Solr还提供了特定过滤器的标记功能，便于控制过滤器与其他Solr功能的交互。<br><a name="EkSoQ"></a></p>
<h3 id="8-7-2-标记、排除和多选分面"><a href="#8-7-2-标记、排除和多选分面" class="headerlink" title="8.7.2 标记、排除和多选分面"></a>8.7.2 标记、排除和多选分面</h3><p>在Solr查询请求中使用过滤器，搜索结果必然会包含每个过滤器。默认情况下，分面也要这样处理。但是，这里有一个问题，我们经常需要查看已经被查询排除在外的搜索结果的分面计数。图8.8讨论了这个问题，在8.2节的餐馆示例数据上请求一些分面，并使用<code>加州</code>这个过滤器。<br /><img src="https://cdn.nlark.com/yuque/0/2021/png/2668706/1635172289840-f8225a2d-5169-4e81-8da3-5fb50620f9fe.png#clientId=u61f0efd5-6ca8-4&from=paste&id=u0ae5b7c4&margin=%5Bobject%20Object%5D&name=image.png&originHeight=606&originWidth=1104&originalType=binary&ratio=1&size=634912&status=done&style=none&taskId=uf4e2c5ae-f151-42de-961e-a4a8639a194" alt="image.png"><br />虽然期望的搜索结果在之前的搜索界面上仅显示加州地区的餐馆，但是如果在分面中继续显示其他州的话，就可以进一步扩展搜索。同样的道理也适用于价格区间分面与城市分面。让用户每次在一个分面上只搜索一个值，这样做是不明智的。<br />所幸，Solr提供分面排除功能来解决这一问题。<strong>分面排除可以添加被搜索请求中任何过滤器过滤掉的文档</strong>。将过滤掉的文档数记入分面数，这样就可以对每个分面进行有效计数，同事忽略该分面上已使用的过滤器。<code>tag</code>和<code>ex</code>是实现这一方法的两个必要局部参数。代码清单8.16演示了如何使用这两个参数对图8.8中的例子进行多选分面。<br /><img src="https://cdn.nlark.com/yuque/0/2021/png/2668706/1635173285213-1c47f5c3-c6ed-4136-b112-4f0538982d03.png#clientId=u61f0efd5-6ca8-4&from=paste&id=u4d4dce91&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1050&originWidth=1106&originalType=binary&ratio=1&size=1041576&status=done&style=none&taskId=u816d6b77-3d74-446d-aa18-bafe210162f" alt="image.png"><br />正如你所见，过滤器将查询限制在加州范围，但是与查询其余部分相匹配的文档数已然按照每个州返回，而不仅仅是显示加州的文档数。图8.9显示了多选分面结果与初始未过滤分面结果的对比。<br /><img src="https://cdn.nlark.com/yuque/0/2021/png/2668706/1635556870561-86978d46-8adb-4cd6-ad09-d96f52df3814.png#clientId=u2c8fe0b8-f0cc-4&from=paste&id=u2f116152&margin=%5Bobject%20Object%5D&name=image.png&originHeight=630&originWidth=1114&originalType=binary&ratio=1&size=342239&status=done&style=none&taskId=u25d0278a-0b84-4049-a1b5-48db8df17b9" alt="image.png"><br />就查询机制而言，<code>tagForState</code>作用于加州的过滤器，实现的语法为<code>fq=&#123;!tag=&quot;tagForState&quot;&#125;state:California</code>。当请求分面时，排除所有标记为<code>tagForState</code>的过滤器，实现的语法为<code>facet.field=&#123;!ex=tagForState&#125;state</code>。<br />你可能无法看到代码清单8.16的搜索结果，但有一点要搞清楚：由于查询中使用了这个过滤器，所以即便州分面没有收到该过滤器的限制，但Solr返回的文档仍然会限制在加州。处于同样的原因，没有标记为<code>tagForState</code>的其他所有分面也受限于加州这个过滤器。<br />另外还需注意，其他分面（如城市和价格）也可能包含排除标记，但他们没有与任何标记过的过滤器相对应。这些排除标记不是必须的，它们不会造成什么问题，也可以被忽略。如果要重新执行这个查询，并在另一个分面值上增加一个过滤器（使用一个排除标记），那么当前未使用的排除标记就会发挥作用。在任何包含排除标记的过滤器出现之前，是否对分面使用排除标记，这由自己决定。如果使用排除标记，语法上可能会先得冗余，但不会对返回的搜索结果造成负面影响。<br />将标记与分面进行混搭，有可能实现有趣的搜索界面和提供一些数据分析功能，不过这些内容已经超出本章范围。如果想要了解更多，请尝试自由探索Solr的这些功能。<br />至此，你已经学习了Solr最常见的分面功能，包括字段分面、查询分面与区间分面。下一节会简要介绍一些高级功能，更多细节内容会在第十五章讨论复杂查询操作时展开。<br><a name="XbHoq"></a></p>
<h2 id="8-8-超越分面基础"><a href="#8-8-超越分面基础" class="headerlink" title="8.8 超越分面基础"></a>8.8 超越分面基础</h2><p>本章简要介绍了Solr最常用的分面功能，这只是拉开了分面的序幕。分面会大量使用Solr的缓存，因此需要对Solr内置缓存的使用方式进行优化，以期最大限度发挥分面请求的性能。第十二章会进一步探讨分面的缓存问题。<br />除了性能优化，第十五章会介绍更多的高级分面形式。有一种高级分面形式称为透视分面，它提供了许多多维度的分面功能。如果只知道标签字段排名靠前的几个值是不够的，还需要知道城市排名靠前的标签，这样的情况应该如何处理？一种方式是先进行一轮搜索，得到城市字段所有值的分面，接下来搜索每个城市的标签分面。不过，这种方式不能很好地扩展，很容易导致执行数十个或上百个搜索，文档集也会变得很庞大。Solr提供透视分面来解决这个问题。透视分面可以在多个维度上进行分面，使用一个搜索返回各个维度上的计算值。要了解高级分面的更多内容，请参见第十五章的15.3节。<br><a name="zPOJ9"></a></p>
<h2 id="8-9-本章小结"><a href="#8-9-本章小结" class="headerlink" title="8.9 本章小结"></a>8.9 本章小结</h2><p>恭喜你读完了颇有深度的一章，这一章介绍了Solr最强大的功能之一。正如你所见，分面提供了一种快捷方式，让用户能够快速掌握与查询匹配的文档的大致情况。现如今，搜索驱动的主流网站几乎都提供分面，帮助用户进行探索式搜寻。Solr的字段分面可以返回每个字段靠前的值，区间分面返回数字与时间值的区间段，查询分面返回任意复杂查询的文档数。<br />你已经知道如何在分面返回时使用键对其重命名，使用标记与分面排除来实现多选分面和返回查询过滤掉文档数。除此之外，本章还介绍了当用户点击分面时，对应地在查询上设置过滤器的各种方法。<br />最后，本章提到了Solr的多维透视分面功能，详细内容会在第十五章的复杂查询操作中进一步讨论。读到此处，你应该能够使用Solr的各种分面方法实现一些复杂的搜索应用了。下一章介绍Solr的另一个常见功能——搜索结果高亮。在搜索结果返回时，将匹配到的文本片段显示在搜索结果列表中，向用户提供潜在的洞察力，帮助用户判断搜索结果中的文档是否值得进一步去探索。</p>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <div class="declare">
      <ul class="post-copyright">
        <li>
          <i class="ri-copyright-line"></i>
          <strong>Copyright： </strong>
          
          Copyright is owned by the author. For commercial reprints, please contact the author for authorization. For non-commercial reprints, please indicate the source.
          
        </li>
      </ul>
    </div>
    
    <footer class="article-footer">
       
<div class="share-btn">
      <span class="share-sns share-outer">
        <i class="ri-share-forward-line"></i>
        分享
      </span>
      <div class="share-wrap">
        <i class="arrow"></i>
        <div class="share-icons">
          
          <a class="weibo share-sns" href="javascript:;" data-type="weibo">
            <i class="ri-weibo-fill"></i>
          </a>
          <a class="weixin share-sns wxFab" href="javascript:;" data-type="weixin">
            <i class="ri-wechat-fill"></i>
          </a>
          <a class="qq share-sns" href="javascript:;" data-type="qq">
            <i class="ri-qq-fill"></i>
          </a>
          <a class="douban share-sns" href="javascript:;" data-type="douban">
            <i class="ri-douban-line"></i>
          </a>
          <!-- <a class="qzone share-sns" href="javascript:;" data-type="qzone">
            <i class="icon icon-qzone"></i>
          </a> -->
          
          <a class="facebook share-sns" href="javascript:;" data-type="facebook">
            <i class="ri-facebook-circle-fill"></i>
          </a>
          <a class="twitter share-sns" href="javascript:;" data-type="twitter">
            <i class="ri-twitter-fill"></i>
          </a>
          <a class="google share-sns" href="javascript:;" data-type="google">
            <i class="ri-google-fill"></i>
          </a>
        </div>
      </div>
</div>

<div class="wx-share-modal">
    <a class="modal-close" href="javascript:;"><i class="ri-close-circle-line"></i></a>
    <p>扫一扫，分享到微信</p>
    <div class="wx-qrcode">
      <img src="//api.qrserver.com/v1/create-qr-code/?size=150x150&data=http://example.com/2021/10/31/Solr%E6%89%8B%E5%86%8C-%E7%AC%AC%E5%85%AB%E7%AB%A0-Solr%E5%88%86%E9%9D%A2%E6%9F%A5%E8%AF%A2/" alt="微信分享二维码">
    </div>
</div>

<div id="share-mask"></div>  
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Solr/" rel="tag">Solr</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Solr%E5%9F%BA%E7%A1%80/" rel="tag">Solr基础</a></li></ul>

    </footer>
  </div>

   
  <nav class="article-nav">
    
    
      <a href="/2021/10/31/Solr%E6%89%8B%E5%86%8C-%E7%AC%AC%E4%B8%83%E7%AB%A0-Solr%E6%9F%A5%E8%AF%A2%E4%B8%8E%E6%90%9C%E7%B4%A2%E7%BB%93%E6%9E%9C/" class="article-nav-link">
        <strong class="article-nav-caption">下一篇</strong>
        <div class="article-nav-title">Solr手册-第七章 Solr查询与搜索结果</div>
      </a>
    
  </nav>

  
   
     
</article>

</section>
      <footer class="footer">
  <div class="outer">
    <ul>
      <li>
        Copyrights &copy;
        2021
        <i class="ri-heart-fill heart_icon"></i> John Doe
      </li>
    </ul>
    <ul>
      <li>
        
      </li>
    </ul>
    <ul>
      <li>
        
      </li>
    </ul>
    <ul>
      
    </ul>
    <ul>
      
    </ul>
    <ul>
      <li>
        <!-- cnzz统计 -->
        
      </li>
    </ul>
  </div>
</footer>    
    </main>
    <div class="float_btns">
      <div class="totop" id="totop">
  <i class="ri-arrow-up-line"></i>
</div>

<div class="todark" id="todark">
  <i class="ri-moon-line"></i>
</div>

    </div>
    <aside class="sidebar on">
      <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/ayer-side.svg" alt="J`Han&#39;s Blog"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">HomePage</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">Document</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags/Solr/">Solr</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags/">Tags</a>
    </li>
    
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
      <a class="nav-item-link nav-item-search"  title="Search">
        <i class="ri-search-line"></i>
      </a>
      
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
    </aside>
    <div id="mask"></div>

<!-- #reward -->
<div id="reward">
  <span class="close"><i class="ri-close-line"></i></span>
  <p class="reward-p"><i class="ri-cup-line"></i>如果觉得对您有帮助，来个打赏吧~</p>
  <div class="reward-box">
    
    <div class="reward-item">
      <img class="reward-img" src="https://cdn.jsdelivr.net/gh/Shen-Yu/cdn/img/alipay.jpg">
      <span class="reward-type">支付宝</span>
    </div>
    
    
    <div class="reward-item">
      <img class="reward-img" src="https://cdn.jsdelivr.net/gh/Shen-Yu/cdn/img/wechat.jpg">
      <span class="reward-type">微信</span>
    </div>
    
  </div>
</div>
    
<script src="/js/jquery-3.6.0.min.js"></script>
 
<script src="/js/lazyload.min.js"></script>

<!-- Tocbot -->
 
<script src="/js/tocbot.min.js"></script>

<script>
  tocbot.init({
    tocSelector: ".tocbot",
    contentSelector: ".article-entry",
    headingSelector: "h1, h2, h3, h4, h5, h6",
    hasInnerContainers: true,
    scrollSmooth: true,
    scrollContainer: "main",
    positionFixedSelector: ".tocbot",
    positionFixedClass: "is-position-fixed",
    fixedSidebarOffset: "auto",
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/jquery-modal@0.9.2/jquery.modal.min.js"></script>
<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/jquery-modal@0.9.2/jquery.modal.min.css"
/>
<script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js"></script>

<script src="/dist/main.js"></script>

<!-- ImageViewer -->
 <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css">
<script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"></script>

<script>
    function viewer_init() {
        let pswpElement = document.querySelectorAll('.pswp')[0];
        let $imgArr = document.querySelectorAll(('.article-entry img:not(.reward-img)'))

        $imgArr.forEach(($em, i) => {
            $em.onclick = () => {
                // slider展开状态
                // todo: 这样不好，后面改成状态
                if (document.querySelector('.left-col.show')) return
                let items = []
                $imgArr.forEach(($em2, i2) => {
                    let img = $em2.getAttribute('data-idx', i2)
                    let src = $em2.getAttribute('data-target') || $em2.getAttribute('src')
                    let title = $em2.getAttribute('alt')
                    // 获得原图尺寸
                    const image = new Image()
                    image.src = src
                    items.push({
                        src: src,
                        w: image.width || $em2.width,
                        h: image.height || $em2.height,
                        title: title
                    })
                })
                var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, {
                    index: parseInt(i)
                });
                gallery.init()
            }
        })
    }
    viewer_init()
</script> 
<!-- MathJax -->

<!-- Katex -->

<!-- busuanzi  -->

<!-- ClickLove -->

<!-- ClickBoom1 -->

<!-- ClickBoom2 -->

<!-- CodeCopy -->
 
<link rel="stylesheet" href="/css/clipboard.css">
 <script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
<script>
  function wait(callback, seconds) {
    var timelag = null;
    timelag = window.setTimeout(callback, seconds);
  }
  !function (e, t, a) {
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '<i class="ri-file-copy-2-line"></i><span>COPY</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      $(".article pre code").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });
      clipboard.on('success', function(e) {
        let $btn = $(e.trigger);
        $btn.addClass('copied');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-checkbox-circle-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPIED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-checkbox-circle-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
      clipboard.on('error', function(e) {
        e.clearSelection();
        let $btn = $(e.trigger);
        $btn.addClass('copy-failed');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-time-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPY FAILED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-time-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
    }
    initCopyCode();
  }(window, document);
</script>
 
<!-- CanvasBackground -->

<script>
  if (window.mermaid) {
    mermaid.initialize({ theme: "forest" });
  }
</script>


    
    

  </div>
</body>

</html>